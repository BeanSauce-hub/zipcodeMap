<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Florida ZIP Volume Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .legend {
      background: white;
      padding: 8px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
      line-height: 1.4;
      font-size:12px;
    }

    .panel {
      position: absolute;
      z-index: 1000;
      left: 10px;
      top: 10px;
      background: rgba(255,255,255,.94);
      padding: 10px 12px;
      border-radius: 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      max-width: 540px;
    }

    .panel h1 { font-size: 18px; margin: 0 0 6px; }

    .panel .row {
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .btn {
      display:inline-block;
      padding:6px 10px;
      border-radius:8px;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-size:12px;
    }

    .input {
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #ddd;
      font-size:13px;
    }

    select {
      padding:4px 8px;
      border-radius:8px;
    }

    .toggle {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }

    .btnseg {
      display:inline-flex;
      gap:6px;
    }

    .btnseg .seg {
      padding:4px 10px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#f7f7f7;
      cursor:pointer;
      font-size:12px;
    }

    .btnseg .seg.active {
      background:#111;
      color:#fff;
      border-color:#111;
    }

    .flash {
      animation: flash 1s ease-in-out 3;
    }

    @keyframes flash {
      0% { filter: drop-shadow(0 0 0 rgba(255,0,0,0)); }
      50% { filter: drop-shadow(0 0 8px rgba(255,0,0,.9)); }
      100% { filter: drop-shadow(0 0 0 rgba(255,0,0,0)); }
    }

    .sparkline { margin-top:6px; }
    .sparkline text { font-size:10px; fill:#555; }
    .leaflet-tooltip { overflow: visible; }
  </style>
</head>

<body>

<div class="panel">
  <h1>Florida ZIP Volume Map</h1>

  <div class="row">
    <label>Date:
      <select id="day"></select>
    </label>
    <div class="btnseg">
      <button class="seg active" id="btn1w">1W</button>
      <button class="seg" id="btn1m">1M</button>
      <button class="seg" id="btnMax">MAX</button>
    </div>
  </div>

  <div class="row">
    <input class="input" id="searchZip" placeholder="Search ZIP" maxlength="5" />
    <div class="btn" id="doSearch">Search</div>
    <div class="btn" id="clearFocus">Clear</div>
  </div>

  <div class="row">
    <label>Threshold:
      <input class="input" id="threshold" type="number" placeholder=">= value" />
    </label>
    <label class="toggle">
      <input type="checkbox" id="thresholdOn" /> Enable
    </label>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  const GH_OWNER  = 'BeanSauce-hub';
  const GH_REPO   = 'zipcodeMap';
  const GH_BRANCH = 'main';

  let windowMode = '1W';
  const daily = {};
  let daysList = [];
  const breaks = {};
  const loadedDays = new Set();

  let focusedZip = null;
  let geoLayer;
  const layerByZip = {};

  function fmt(n){ return (Number(n)||0).toLocaleString(); }
  function normZip(z){ return String(z).replace(/\D/g,'').padStart(5,'0'); }

  function getColor(v,b){
    if (v == null) return '#f2f2f2';
    if (v <= b[0]) return '#ffffcc';
    if (v <= b[1]) return '#ffeda0';
    if (v <= b[2]) return '#feb24c';
    if (v <= b[3]) return '#fd8d3c';
    return '#e31a1c';
  }

  const map = L.map('map').setView([27.8, -81.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:12, attribution:'© OpenStreetMap'
  }).addTo(map);
  map.zoomControl.setPosition('bottomleft');

  function styleFeature(f){
    const z = f.properties.ZCTA5CE10;
    const d = document.getElementById('day').value;
    const v = daily[d]?.[z];
    return {
      weight:.7,
      color:'#555',
      fillOpacity:.82,
      fillColor:getColor(v, breaks[d]||[0,0,0,0])
    };
  }

  function onEachFeature(f,l){
    const z = f.properties.ZCTA5CE10;
    layerByZip[z] = l;

    l.bindTooltip(() => {
      const d = document.getElementById('day').value;
      const v = daily[d]?.[z];
      return `<b>${z}</b><br>${d}: ${v ?? '—'}`;
    }, {sticky:true});
  }

  fetch('./fl_florida_zip_codes_geo.min.json')
    .then(r=>r.json())
    .then(gj=>{
      geoLayer = L.geoJSON(gj,{style:styleFeature,onEachFeature}).addTo(map);
      map.fitBounds(geoLayer.getBounds());
    });

  // legend
  const legend = L.control({position:'bottomright'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = `
      <b>Color Legend</b><br>
      <i style="background:#ffffcc"></i> Low<br>
      <i style="background:#e31a1c"></i> High
    `;
    return div;
  };
  legend.addTo(map);
</script>

</body>
</html>
