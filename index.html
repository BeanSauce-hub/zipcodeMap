<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Florida ZIP Volume Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .panel{
      position:absolute; z-index:1000; left:10px; top:10px;
      background:rgba(255,255,255,.96);
      padding:12px 14px;
      border-radius:14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      max-width:560px;
    }

    .panel h1{ font-size:18px; margin:0 0 6px; }

    .row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:8px;
    }

    .btn{
      padding:6px 12px;
      border-radius:8px;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-size:12px;
      border:none;
    }

    .btn.secondary{
      background:#eee;
      color:#111;
    }

    .input{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #ddd;
      font-size:13px;
    }

    .btnseg{ display:flex; gap:6px; }
    .btnseg .seg{
      padding:4px 10px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#f7f7f7;
      cursor:pointer;
      font-size:12px;
    }
    .btnseg .seg.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    .legend{
      background:#fff;
      padding:8px 10px;
      border-radius:8px;
      font-size:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }

    .info{
      background:#fff;
      padding:6px 8px;
      border-radius:8px;
      font-size:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }

    .flash{
      animation: flash 1s ease-in-out 3;
    }
    @keyframes flash{
      0%{ filter:none }
      50%{ filter:drop-shadow(0 0 8px rgba(255,0,0,.9)) }
      100%{ filter:none }
    }

    .cleaner{
      border:1px dashed #ddd;
      border-radius:10px;
      padding:10px;
      margin-top:10px;
    }

    .progress{
      width:100%;
      height:6px;
      background:#eee;
      border-radius:6px;
      overflow:hidden;
      margin-top:6px;
    }
    .progress > div{
      height:100%;
      width:0%;
      background:#111;
      transition:width .25s;
    }
  </style>
</head>

<body>

<div class="panel">
  <h1>Florida ZIP Volume Map</h1>

  <div class="row">
    <label>Date:
      <select id="day" class="input"></select>
    </label>

    <div class="btnseg">
      <button class="seg" id="btn1w">1W</button>
      <button class="seg" id="btn1m">1M</button>
      <button class="seg" id="btnMax">MAX</button>
    </div>

    <button class="seg" id="reload7">Reload 7 days</button>
  </div>

  <div class="row">
    <input id="searchZip" class="input" placeholder="Search ZIP" maxlength="5" />
    <button class="btn" id="doSearch">Search</button>
    <button class="btn secondary" id="clearSearch">Clear</button>
  </div>

  <div class="row">
    <input id="threshold" class="input" placeholder=">= value" style="width:90px" />
    <label><input type="checkbox" id="thresholdOn" /> Enable</label>
  </div>

  <!-- Cleaner -->
  <div class="cleaner">
    <div class="row">
      <button class="btn" id="uploadBtn">Upload & Clean</button>
      <span id="fileName">None</span>
    </div>
    <div class="progress"><div id="progressBar"></div></div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- ✅ XLSX 解析库（SheetJS） -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ---------------- CONFIG ---------------- */
const GH_OWNER='BeanSauce-hub';
const GH_REPO='zipcodeMap';
const GH_BRANCH='main';

/* ---------------- STATE ---------------- */
let windowMode='1W';
const daily={};
let daysList=[];
const breaks={};
let focusedZip=null;

// Cleaner parsed cache (for next step cleaning logic)
let cleanerLast = {
  fileName: null,
  zipKey: null,
  rows: null
};

/* ---------------- MAP ---------------- */
const map=L.map('map').setView([27.8,-81.7],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:12}).addTo(map);
map.zoomControl.setPosition('bottomleft');

const info=L.control();
info.onAdd=()=>info._div=L.DomUtil.create('div','info');
info.update=(p)=>{
  if(!p){ info._div.innerHTML=''; return;}
  info._div.innerHTML=p.html;
};
info.addTo(map);

let geoLayer;
const layerByZip={};

/* ---------------- UTILS ---------------- */
const normZip=z=>String(z ?? '').trim().replace(/\D/g,'').padStart(5,'0').slice(0,5);
const fmt=n=>(+n||0).toLocaleString();

function getColor(v,b){
  if(v==null) return '#f2f2f2';
  if(v<=b[0]) return '#ffffcc';
  if(v<=b[1]) return '#ffeda0';
  if(v<=b[2]) return '#feb24c';
  if(v<=b[3]) return '#fd8d3c';
  return '#e31a1c';
}

// normalize header for matching (case-insensitive, trim, remove spaces)
function normHeader(h){
  return String(h ?? '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g,'');
}

// Find ZIP column name among: zipcode / zip / 邮编 (any case)
function findZipKeyFromHeaders(headers){
  const targets = new Set(['zipcode','zip','邮编']);
  const mapNorm = new Map(); // norm -> original
  headers.forEach(h => mapNorm.set(normHeader(h), h));

  // exact matches
  for (const t of targets){
    if (mapNorm.has(t)) return mapNorm.get(t);
  }

  // fallback: contains match (e.g., "ZIP Code", "ZipCode(目的地)")
  for (const [k, orig] of mapNorm.entries()){
    if (k.includes('zipcode')) return orig;
    if (k === 'zip') return orig;
    if (k.includes('邮编')) return orig;
  }
  return null;
}

function setProgress(pct){
  document.getElementById('progressBar').style.width = Math.max(0, Math.min(100, pct)) + '%';
}

function startFakeProgress(){
  setProgress(0);
  let p = 0;
  const timer = setInterval(()=>{
    p = Math.min(92, p + Math.random()*12);
    setProgress(p);
  }, 120);
  return ()=>{ clearInterval(timer); };
}

/* ---------------- GEO ---------------- */
fetch('./fl_florida_zip_codes_geo.min.json')
  .then(r=>r.json())
  .then(gj=>{
    geoLayer=L.geoJSON(gj,{
      style:f=>{
        const z=f.properties.ZCTA5CE10;
        const d=document.getElementById('day').value;
        const v=daily[d]?.[z];
        return {weight:.7,color:'#555',fillOpacity:.82,fillColor:getColor(v,breaks[d]||[0,0,0,0])};
      },
      onEachFeature:(f,l)=>{
        const z=f.properties.ZCTA5CE10;
        layerByZip[z]=l;
        l.on('mouseover',()=>{
          l.setStyle({weight:2,color:'#000'});
          info.update({html:`ZIP ${z}<br>${fmt(daily[document.getElementById('day').value]?.[z])}`});
        });
        l.on('mouseout',()=>geoLayer.resetStyle(l));
      }
    }).addTo(map);
    map.fitBounds(geoLayer.getBounds());
  });

/* ---------------- SEARCH ---------------- */
document.getElementById('doSearch').onclick=()=>{
  const q=document.getElementById('searchZip').value;
  const z=Object.keys(layerByZip).find(k=>k.startsWith(q));
  if(!z) return;
  focusedZip=z;
  const l=layerByZip[z];
  map.fitBounds(l.getBounds(),{maxZoom:10});
  l.getElement()?.classList.add('flash');
};

document.getElementById('clearSearch').onclick=()=>{
  focusedZip=null;
  geoLayer?.setStyle(geoLayer.options.style);
};

/* ---------------- CLEANER: upload csv/xlsx ---------------- */
const fileInput=document.createElement('input');
fileInput.type='file';
fileInput.accept='.csv,.xlsx';
fileInput.style.display='none';
document.body.appendChild(fileInput);

document.getElementById('uploadBtn').onclick=()=>fileInput.click();

fileInput.onchange=async ()=>{
  const f=fileInput.files?.[0];
  if(!f) return;

  document.getElementById('fileName').textContent=f.name;

  const stopFake = startFakeProgress();

  try{
    const ext = (f.name.split('.').pop() || '').toLowerCase();

    let headers = [];
    let rows = [];

    if (ext === 'csv'){
      const text = await f.text();
      const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
      rows = (parsed.data || []).map(r => r || {});
      headers = (parsed.meta?.fields || Object.keys(rows[0] || {}));
    } else if (ext === 'xlsx'){
      const ab = await f.arrayBuffer();
      const wb = XLSX.read(ab, {type:'array'});
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      // defval keeps empty cells as ""
      rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      headers = Object.keys(rows[0] || {});
    } else {
      throw new Error('Unsupported file type');
    }

    setProgress(94);

    const zipKey = findZipKeyFromHeaders(headers);
    if (!zipKey){
      setProgress(0);
      throw new Error('ZIP column not found (zipcode / ZIP / 邮编)');
    }

    // cache for next step cleaning logic
    cleanerLast = { fileName: f.name, zipKey, rows };

    // quick validation pass (no heavy cleaning yet)
    // just normalize a few zips to prove it works
    let seen = 0;
    for (let i=0;i<rows.length && seen<5;i++){
      const z = normZip(rows[i][zipKey]);
      if (z && z !== '00000') seen++;
    }

    setProgress(100);
  } catch (e){
    console.error(e);
    alert(e.message || String(e));
  } finally {
    stopFake();
    setProgress(100);
    setTimeout(()=>setProgress(0), 500);
    // allow re-upload same file
    fileInput.value = '';
  }
};
</script>
</body>
</html>
