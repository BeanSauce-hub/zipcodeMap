<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>佛州货量地图</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend { background: white; padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,.12); line-height: 1.4; font-size:12px; }
    .info { padding: 6px 8px; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,.12); font-size:12px; }
    .panel {
      position: absolute; z-index: 1000; left: 10px; top: 10px;
      background: rgba(255,255,255,.94); padding: 10px 12px; border-radius: 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Noto Sans', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif;
    }
    .panel h1 { font-size: 18px; margin: 0 0 6px; }
    .panel .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .btn { display:inline-block; padding:6px 10px; border-radius:8px; background:#111; color:#fff; text-decoration:none; cursor:pointer; font-size:12px; }
    .input { padding:6px 8px; border-radius:8px; border:1px solid #ddd; font-size:13px; }
    select{ padding:4px 8px; border-radius:8px; }
    .hint{font-size:12px;color:#666;margin-top:6px;}
    .sparkline canvas{ width:240px; height:96px; }
  </style>
</head>
<body>
  <div class="panel">
    <h1>佛罗里达州 ZIP 货量地图</h1>

    <div class="row">
      <label>日期：
        <select id="day"></select>
      </label>
    </div>

    <div class="row">
      <input class="input" id="searchZip" placeholder="搜索 ZIP（支持前缀/完整）" maxlength="5" />
      <a class="btn" id="doSearch">搜索</a>
      <a class="btn" id="exportCsv">导出当日明细</a>
    </div>

    <div class="row">
      <label>阈值高亮：<input class="input" style="width:100px" id="threshold" type="number" placeholder=">= 数值" /></label>
      <label><input type="checkbox" id="thresholdOn" /> 启用</label>
    </div>

    <div class="hint">
      本页会自动扫描仓库根目录中的 <code>YYYY-MM-DD.csv</code>。CSV 需含：<b>Zipcodes</b> +（<b>Quantity</b> / <b>pred_quantity</b> / <b>数量</b> / <b>货量</b>）。
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // ====== 配置你的仓库信息（一定要改成你的仓库）======
    const GH_OWNER  = 'BeanSauce-hub';
    const GH_REPO   = 'zipcodeMap';
    const GH_BRANCH = 'main';
    // ====================================================

    // ---------- 工具 ----------
    function fmt(n){ return (Math.round((Number(n)||0)*100)/100).toLocaleString(); }
    function normZip(z){
      let s = String(z ?? '').trim();
      if (s.endsWith('.0')) s = s.slice(0,-2);
      s = s.replace(/\D/g,'');
      if (s.length > 5) s = s.slice(0,5);
      return s.padStart(5,'0');
    }
    function parseCsv(text){
      const out = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: false });
      const rows = out.data.map(r=>{
        const obj = {}; Object.keys(r).forEach(k=>{ obj[k?.trim?.()] = String(r[k] ?? '').trim(); });
        return obj;
      });
      const headers = out.meta.fields || [];
      return { headers, rows };
    }
    function sortAsc(arr){ return arr.slice().sort((a,b)=> a.localeCompare(b)); }

    // ---------- 地图 ----------
    const map = L.map('map').setView([27.8, -81.7], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 12, attribution: '&copy; OpenStreetMap'}).addTo(map);
    map.zoomControl.setPosition('bottomleft');

    const info = L.control();
    info.onAdd = function(){ this._div = L.DomUtil.create('div','info'); this.update(); return this._div; };
    info.update = function(props){
      if (!props) { this._div.innerHTML = '将鼠标悬停到区域上查看数据'; return; }
      const zip = props.ZCTA5CE10 || props.ZCTA5CE || props.zip || '';
      const cur = daySel.value;
      this._div.innerHTML = buildTooltipHTML(zip, cur);
    };
    info.addTo(map);

    let geoLayer;
    const layerByZip = {};
    const daySel = document.getElementById('day');
    const searchInput = document.getElementById('searchZip');
    const doSearch = document.getElementById('doSearch');
    const exportCsv = document.getElementById('exportCsv');

    const daily = {};     // { 'YYYY-MM-DD': { 'zip': value } }
    let daysList = [];    // ['2025-08-11', ...]
    const breaks = {};    // { day: [q20,q40,q60,q80] }

    const thresholdOn = document.getElementById('thresholdOn');
    const thresholdInput = document.getElementById('threshold');

    function getZipFromFeature(f){ return (f.properties.ZCTA5CE10 || f.properties.ZCTA5CE || f.properties.zip || '').toString().padStart(5,'0'); }

    function getColor(d, b) {
      if (d == null) return '#f2f2f2';
      if (d <= b[0]) return '#ffffcc';
      if (d <= b[1]) return '#ffeda0';
      if (d <= b[2]) return '#feb24c';
      if (d <= b[3]) return '#fd8d3c';
      return '#e31a1c';
    }
    function overThreshold(val){
      if (!thresholdOn.checked) return false;
      const t = Number(thresholdInput.value);
      if (!isFinite(t)) return false;
      return (Number(val)||0) >= t;
    }

    function styleFeature(feature){
      const z = getZipFromFeature(feature);
      const d = daySel.value;
      const val = (daily[d] && daily[d][z] != null) ? daily[d][z] : null;
      const base = {weight:.7, opacity:1, color:'#555', fillOpacity:.82, fillColor:getColor(val, breaks[d]||[0,0,0,0])};
      if (overThreshold(val)) { base.color='#e31a1c'; base.weight=2; }
      return base;
    }
    function highlightFeature(e){
      const layer = e.target; layer.setStyle({weight:2.5,color:'#000',fillOpacity:.9}); layer.bringToFront();
      const z=getZipFromFeature(layer.feature);
      info.update({ ZCTA5CE10:z });
    }
    function resetHighlight(e){ geoLayer.resetStyle(e.target); info.update(); }
    function onEachFeature(feature,layer){
      const z = getZipFromFeature(feature);
      layerByZip[z] = layer;
      layer.on({mouseover:highlightFeature, mouseout:resetHighlight, click:highlightFeature});
      layer.bindTooltip(() => buildTooltipHTML(z, daySel.value), { sticky: true });
    }

    function computeBreaks(values){
      const vals = values.filter(v=>v>0 && isFinite(v)).sort((a,b)=>a-b);
      if (!vals.length) return [0,0,0,0];
      const q = p => vals[Math.floor(p*(vals.length-1))];
      return [q(.2), q(.4), q(.6), q(.8)];
    }
    function updateBreaksFor(day){
      const vals = Object.values(daily[day]||{}).map(v=>+v||0);
      breaks[day] = computeBreaks(vals);
    }
    function refreshMap(){
      const d = daySel.value;
      if (!d || !geoLayer) return;
      updateBreaksFor(d);
      geoLayer.setStyle(styleFeature);
      legend.update();
      info.update(info._lastProps);
    }

    const legend=L.control({position:'bottomright'});
    legend.onAdd=function(map){ this._div=L.DomUtil.create('div','legend'); this.update(); return this._div; };
    legend.update=function(){
      const d = daySel.value; const b = breaks[d]||[0,0,0,0];
      const colors = ['#ffffcc','#ffeda0','#feb24c','#fd8d3c','#e31a1c'];
      const labels = [
        `${fmt(0)} – ${fmt(b[0])}`,
        `${fmt(b[0])} – ${fmt(b[1])}`,
        `${fmt(b[1])} – ${fmt(b[2])}`,
        `${fmt(b[2])} – ${fmt(b[3])}`,
        `>${fmt(b[3])}`
      ];
      let html = '<b>颜色图例</b><br/>';
      for (let i=0; i<labels.length; i++) {
        html += `<i style="background:${colors[i]};width:14px;height:14px;display:inline-block;margin-right:6px;border:1px solid #999"></i>${labels[i]}<br/>`;
      }
      this._div.innerHTML = html;
    };
    legend.addTo(map);

    const _origInfoUpdate = info.update.bind(info);
    info.update = function(props){ this._lastProps = props || this._lastProps; _origInfoUpdate(this._lastProps); };

    // ---------- 迷你折线图（Chart.js，y 轴从 0 起） ----------
    let miniCharts = new Map();
    function buildTooltipHTML(zip, currentDay) {
      const val = daily[currentDay]?.[zip];
      const valHtml = (val == null || Number.isNaN(val)) ? '<span style="color:#999">—</span>' : `<b style="background:rgba(255,230,150,.6);padding:0 4px;border-radius:4px">${fmt(val)}</b>`;
      const id = `spark-${zip}`;
      return `
        <div><b>ZIP:</b> ${zip}</div>
        <div style="margin-top:4px"><b>${currentDay}</b>：${valHtml}</div>
        <div class="sparkline"><canvas id="${id}" width="240" height="96"></canvas></div>
      `;
    }
    function renderMiniChart(zip, canvas) {
      // 构造最近 14 天的标签与数据，缺失补 0
      const N = 14;
      const days = sortAsc(daysList);
      const endIdx = Math.max(days.indexOf(daySel.value), days.length - 1);
      const startIdx = Math.max(0, endIdx - (N - 1));
      const seg = days.slice(startIdx, endIdx + 1);
      const labels = seg.map(d => {
        const day = parseInt(d.slice(8,10), 10);
        if (day === 1) return d.slice(5,7) + '-1';
        if (day % 5 === 0) return String(day);
        return '';
      });
      const data = seg.map(d => {
        // 如果当日还没加载，给 0；已加载就取值
        return daily[d]?.[zip] ?? 0;
      });

      if (miniCharts.has(zip)) { miniCharts.get(zip).destroy(); }
      const chart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: { labels, datasets: [{ data, borderColor:'#d62728', backgroundColor:'transparent', pointRadius:3, tension:0 }] },
        options: {
          animation:false,
          plugins:{ legend:{ display:false }, tooltip:{ enabled:false } },
          scales:{
            x:{ ticks:{ color:'#555', maxRotation:0, autoSkip:false } },
            y:{ beginAtZero:true, ticks:{ color:'#555' } }
          },
          responsive:false,
        }
      });
      miniCharts.set(zip, chart);
    }

    // ---------- 自动扫描仓库 CSV ----------
    async function fetchCsvDatesFromGitHub() {
      const api = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/git/trees/${GH_BRANCH}?recursive=1`;
      const r = await fetch(api, { cache: 'no-store' });
      if (!r.ok) throw new Error(`GitHub API ${r.status}`);
      const data = await r.json();
      const dates = (data.tree || [])
        .filter(n => n.type === 'blob' && /\.csv$/i.test(n.path))
        .map(n => {
          const m = n.path.match(/^(\d{4}-\d{2}-\d{2})\.csv$/i); // 仅根目录
          return m ? m[1] : null;
        })
        .filter(Boolean)
        .sort((a,b)=> a.localeCompare(b));
      return dates;
    }

    async function fetchDayCsv(dayISO){
      const r = await fetch(`./${dayISO}.csv?ts=` + Date.now(), {cache:'no-store'});
      if (!r.ok) throw new Error(`读取 ${dayISO}.csv 失败：${r.status}`);
      const text = await r.text();
      const { headers, rows } = parseCsv(text);
      const lowerHeaders = headers.map(h=>h?.trim?.().toLowerCase());

      let zipKey=null, valKey=null;
      for (const a of ['zipcodes','zip','zipcode','zip_code']){
        const idx = lowerHeaders.indexOf(a);
        if (idx!==-1){ zipKey = headers[idx]; break; }
      }
      for (const a of ['quantity','pred_quantity','数量','货量']){
        const idx = lowerHeaders.indexOf(a);
        if (idx!==-1){ valKey = headers[idx]; break; }
      }
      if (!zipKey || !valKey) throw new Error("CSV 缺少 Zipcodes 或 数量列");

      daily[dayISO] = {};
      rows.forEach(r=>{
        const z = normZip(r[zipKey]);
        const v = Number(String(r[valKey]).replace(/,/g,'')) || 0;
        if (z && z!=='00000') daily[dayISO][z] = v;
      });
    }

    function renderDayOptions(){
      const sel = daySel;
      const cur = sel.value;
      sel.innerHTML = '';
      daysList.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        sel.appendChild(opt);
      });
      if (daysList.length){
        sel.value = daysList.includes(cur) ? cur : daysList[daysList.length-1];
      }
    }

    async function loadAllFromRepo(){
      daySel.disabled = true;
      try{
        daysList = await fetchCsvDatesFromGitHub();
        if (!daysList.length){ alert('仓库里没找到 YYYY-MM-DD.csv'); return; }

        // 懒加载：先加载最新一天，其余在弹 tooltip 时再按需加载
        await fetchDayCsv(daysList.at(-1));
        renderDayOptions();

        // 加载 GeoJSON 并渲染
        const gj = await (await fetch('./fl_florida_zip_codes_geo.min.json', {cache:'no-store'})).json();
        if (geoLayer) map.removeLayer(geoLayer);
        geoLayer = L.geoJSON(gj, { style: styleFeature, onEachFeature: (f,l)=>{
          onEachFeature(f,l);
          l.on('popupopen', async (e)=>{
            const z = getZipFromFeature(f);
            // 迷你图需要最近 14 天，确保都有数据（没加载的就补拉取）
            const N=14, ds = sortAsc(daysList);
            const endIdx = Math.max(ds.indexOf(daySel.value), ds.length - 1);
            const startIdx = Math.max(0, endIdx - (N - 1));
            for (const d of ds.slice(startIdx, endIdx+1)) {
              if (!daily[d]) { try{ await fetchDayCsv(d); }catch(_){ daily[d] = {}; } }
            }
            const canvas = e.popup._contentNode.querySelector('canvas');
            if (canvas) renderMiniChart(z, canvas);
          });
        }}).addTo(map);
        map.fitBounds(geoLayer.getBounds());
        refreshMap();
      }catch(e){
        console.error(e);
        alert('自动扫描仓库失败：' + e.message);
      }finally{
        daySel.disabled = false;
      }
    }

    // Search & Export
    function focusZip(query){
      if (!geoLayer) { alert('请先加载 GeoJSON。'); return; }
      const q = (query||'').trim(); if (!q) return;
      const target = Object.keys(layerByZip).find(z => z.startsWith(q));
      if (!target) { alert('未找到匹配的 ZIP。'); return; }
      const layer = layerByZip[target];
      map.fitBounds(layer.getBounds(), {maxZoom: 10});
      const el = layer.getElement();
      if (el){ el.classList.add('flash'); setTimeout(()=> el.classList.remove('flash'), 1800); }
      layer.openTooltip();
    }
    doSearch.addEventListener('click', ()=> focusZip(searchInput.value));
    searchInput.addEventListener('keydown', e=>{ if (e.key==='Enter') focusZip(searchInput.value); });

    function exportCurrent(){
      const d = daySel.value;
      window.open(`${d}.csv`, '_blank');
    }
    exportCsv.addEventListener('click', exportCurrent);

    // 交互刷新
    daySel.addEventListener('change', refreshMap);
    thresholdOn.addEventListener('change', refreshMap);
    thresholdInput.addEventListener('change', refreshMap);

    // 页面加载后自动扫描
    document.addEventListener('DOMContentLoaded', () => {
      loadAllFromRepo();
    });
  </script>
</body>
</html>
